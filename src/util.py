import hashlib
import json
import os
from concurrent.futures import ThreadPoolExecutor
from urllib.parse import urljoin, urlparse

import m3u8
import requests
import tqdm

import AES
# self
import constant as const

# import tqdm

aes = AES.AES_ENCRYPT()


def getCfg():
    return const.cfg


def getParam(d):
    # 签名计算
    sorted_d = dict(sorted(d.items(), key=lambda item: item[0]))
    sorted_d_str = "&".join(f"{k}={v}" for k, v in sorted_d.items())
    sig = md5('%s%s' % (sorted_d_str, const.SIG_KEY)).upper()
    d['signature'] = sig
    # 参数加密
    data = aes.encrypt(json.dumps(d))
    # print(d)
    return 'data=%s&device_version=h5&device_type=iPhone&version_code=1.0&device=h5&api_token=&c_name=developer-default' % (data)


def md5(text):
    md = hashlib.md5()  # 获取一个md5加密算法对象
    md.update(text.encode('utf-8'))  # 制定需要加密的字符串

    return md.hexdigest().upper()


def post(url, data):
    # 获取域名
    fd = getParam(data)
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
        # 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36',
        # 'authority': urlparse(url).netloc
    }

    response = requests.request("POST", url, headers=headers, data=fd)

    return decrypt(response.text)


def decrypt(hex):
    return json.loads(aes.decrypt(hex))


def download(url: str, fname: str, title: str):
    resp = requests.get(url, stream=True)
    total = int(resp.headers.get('content-length', 1))
    total_unit = '%.2f' % (total / 1024 / 1024)
    desc = 'title: %s\tfile_name: %s' % (title, fname)
    chunk = 1024
    with open(fname, 'wb') as file, tqdm.tqdm(desc=desc,
                                              total=total,
                                              unit='iB',
                                              unit_scale=True,
                                              unit_divisor=1024) as bar:
        for data in resp.iter_content(chunk_size=chunk):
            size = file.write(data)
            bar.update(size)

    print('title: %s\t下载完成 %sMb' % (title, total_unit))

from tqdm import tqdm

executor = ThreadPoolExecutor(max_workers=10)
def download_segment(ts_url, ts_file, progress_bar):
    # print(f"Downloading {ts_url}")
    response = requests.get(ts_url, stream=True)

    if response.status_code == 200:
        for chunk in response.iter_content(chunk_size=1024):
            ts_file.write(chunk)
            progress_bar.update(len(chunk))
    else:
        print(f"Failed to download {ts_url}")

def get_filename_from_url(url):
    parsed_url = urlparse(url)
    filename = os.path.basename(parsed_url.path)
    return filename

def download_m3u8_video(m3u8_url, output_path):
    # 下载并解析m3u8文件
    print(f'开始解析m3u8: {m3u8_url}')
    m3u8_obj = m3u8.load(m3u8_url)

    ts_files = [open(os.path.join('downloads/', get_filename_from_url(seg.uri)), 'wb') for seg in m3u8_obj.segments]
    ts_urls = [urljoin(m3u8_url, seg.uri) for seg in m3u8_obj.segments]
    print(f'准备下载ts: {len(ts_files)}')

    # 使用线程池下载所有的ts文件
    with tqdm(unit='B', unit_scale=True, dynamic_ncols=True) as progress_bar:
        list(executor.map(download_segment, ts_urls, ts_files, [progress_bar]*len(ts_urls)))

    # 合并所有的ts文件
    with open(output_path, "wb") as merged:
        for ts_file in ts_files:
            ts_file.close()
            with open(ts_file.name, "rb") as mergefile:
                merged.write(mergefile.read())

    # 删除所有的ts文件
    for ts_file in ts_files:
        os.remove(ts_file.name)

def createDirIfNotExist(path: str):
    if not os.path.exists(path):
        os.mkdir(path)


# print(decrypt("6C2CCC9622981ACC075EE0010D18D677E89C02371C091B85C6AFF2EB1971073305CBA4853F10A99008C67356E1327F0BE10ED2ECE1D6895614C1022ADC16D98B040D458D1ED13224E32C933B71018834AB2692A069B71EB5279B0EA28DC9D58B35321F9286C85236005A725B5E62AA24682E302C61628B4DCCE5EA980B3C0071E308B5F0D92975B33685F7650BF5563CF195182843BED112E109B9BDAD78DF35D188E5818CD9CBD068753D790DE162927183A078FA55E1FB01720171E6A2C9BE940AD81BEEF8DE48069550299AB07192F3CEA3FE293D284828F72389715E653B755F4D270D6DF78C1389B0DF150CEFED87A38BF4E9503E10357CB99E9C3ACF0808646B1671CCE121EA2630C183B79E1D54BD21B65ABBE93A4B556E6AA27C8CBAF69330D22030417FC59D665F37DEA0215D02B71F35BAC13BA35C19C622532EED83B8477F9845B784917F05E17B18A07C4EF6032725121082CCAA62AA56CEB8416B60EEC938DF9AB7739746B16A5BB82DCAE13F74123F5113C2A7BE32CDF1AEA91BC63FF9E9C113066D3525B3361798CC1BFD760C9EE2C61C6E874F78BC930C6945F3B4A7D7EEC3A00EA93283C16216689F0B2599A3FA9E06192A7776964674AA2AAC412118984B7A121E3FD9C39BC4D7F41701C5DF52C72AF1EEE0D7575020ECA2AE766C801524AD7E01CA04FAB418C72F9F749B4C80DE51DF66902D90898B4478422129B5DBEC5547690A6FAE50A6F2EFA93ED67F181FB330AABA7A5AA1081E33B0FE91C14516F718C32C1F92C8A195840E71DF0F163C834F147F7829E27B9EC83AE2195AD4D2B0D9B52395EFAEC0BD58D93727258201E062FAEA0D5DF5E712BF4A3D9F639F7A29A13EDD636770D8B4CF1D2778256B47535EEDF406F001E18AF38C5BD26268E6C4583D4E4C6F0C78C1720C5E6E785DB5BF824E2E84302893A144388944542F23FB3C3C7566151836D2BFF587C1269476048211A7BE5F97975E50739D21D64F512707CF857290BD39BEFB4AD485A3323153C949E61AB9AC46E2AB9364A8B5BF79717F0B5C140A59CEF218617E2973018129623CC65B0DBC34820E7D3E6749C65638B00F76EFBC4FCA3202DDEF7D8201955224ABF9CF4CFBFEFE5684490BA2BACE00ECEF164903EDB3C0C0C0B952EFD734F1A2B4CACD89B9D0E009430BA27BEF14D6E2A61E2AD55CD4349E4F7B03262AAA56339BDD0845397E9B570230B222AA9708507D7643319FD5AFE13ACA4EA35E6C4C4176B3C13AB7B800C7A92A081F2670FCC80169C85A8D4BDD25E020A67B07E5CEF78350E4B2C898557C724461753F950017CA4C45A11D4533EB9BAC61F8225F1A1C249602DD2B2D7E572DEEEC2C9E481215E24406ED743904317BD5A5474E36A7F500269259166652FE93C8844BF396B4DAC373BA4A663921209E3BB8F5F8FFE87C0BB4A161898E08261DA5FC9FE9D4D14FEC897BBA1BDF9961229008ACA9205158F50491874942FC1D05D147E83F879FF4C95D78053CE676142B44254186F5E3CDAF1B049EE09672505378B29C509FDB9D5C471D96309F690B986EAAABA3181D5389C2945CFD09DB4893C1368B8BB200830BC23EC9FD114351182126B7589AA9455E7EFAE2222A256ABD35A2B18ED41821E7BCA0F8919D2B624C1D43489AC7AC062DCA7DF316987E1837644AAC17311FBBA4E5A38593CDB74A79D7FFE2C28849E33ACEC10E7BE419F77EB13557BA2300A04BCF034CF289C8AA6BFB140F44A4DBE3A3EDCF944DE3F708717A199F1813D17C27FF3D4215EE12297FFD657D2F64EA607CCBC32F1ED3716A473DBB2C2C74FF33BFD140111C5A801403E3CD22C874B9CAD6CA9BD8531B347B8518EAE1A053C35072DE3785D4711EDBB0814BB735F3A43DC4217A99BBA5F68CE4C2B3AB4E8B29ABDBA526106F776BF4891F652A08688D3ED5519F6D9F299BD95F815715EEC94FBEE158EAA69B349712CA90CA3886DF254957429A3530A6B686D85FFB6580A25B9256E919FAE363BCF0826A1BCEE4399571EC98D17BA4FAF1D03EF16A7627E02C211A2FCF616DA524A0F0AA272C87956395DAE8EE7A1B34D7F951EBA7B83B6A179826ED446E2E2639A8FBCA67AB8C7331570CCF3EF0E09F94F49010B1CE434C879E68B7ED8A668C42D4820591858A53B9C39A61712884A05D16A6820D91DCB7F63373068CE3C30C1E7843E1BD53799F04367969521CCD7F86826C8A551CF76B395056EDA00CAD3A4F3C5D396B7DE13350E06D81751E72608DF68F7E177F6DE851399887856B7BE6A2CD158C9C8748401905245A413E2719E91B5E1DCB63ED79071CE181873B8059EA25B9003586C473904D7170946DC03949C76EC06DAAA5149604F2978CF3A94C1C2C137555B6D9A1394D9B22D2F439B290781D11B7F2871AB1AF4D65D3AF7676ACB27C16F5B2AAAE262A2ABCBCD768827D56F8779C55A7E1A4B025E4AC7DB839B2767B6D2F4226FF335066B0F7A00A337190677E06D0F6E5A3B7946D8319C32A670D321B9383EF9087FBABE3262D3CABD50584EEB71BBA68AEB1A47C0B91EB17CC5D43D3D4495B229EC17746A13FE7D61D531198AB01CCB04E02C567779CC8B4064ED939253070C8E70FF9A291ED4BF1CA103FF95AE0BD2056C14697AF99C6FDD7DB9F7A305D38AE87946B2894083F90EACC8C17365628823A91D5E00793415A6F7301D4834EE1FFDD65BCF7CAA22EBF0960F942B2F36EC6B84FE3E404DB2CC6C7171C2C327B4F89B271DE751E3805B06159467CF7C73F3350A87213D4F614A2567DF23FD29794CCBBD26076E9947EC9758719E8DCD70E5421CFCDA10D478AB1C6EFACA0DAA5DB90D22F5EE713A963D0355F54AEC1918101F7CC2B3828B5912A7FEF2B0DC6804FF8AD1CA7DC8C04192F52F9B617D7D39C9D7ABE392F8049D15D1CF6CE9546E0178D470A2221C2812F06781CEDB85D2C68F56FFD956436F859212576C5652A76B1979D6DBB88058DD196A98A8D7E7FF39ABCF1DF98639A5DA9B100A358D1CB5118BAF21B82B005ED58D022097E3AFF1343A4A2324884969858C0A070F9808F548448315ECD8ABCA74086616FD343899241470AC059968228C69772F1F4B622DADB90400D587669D101A473206BA669EEA2359DEDF3D12494B0447D556233C7D49D26D0004DAE6D3271BCC5614C72FDF7DE22CBEED9BD022DA48F7C043EEC6A9457607CCDE4328A033642CF3516F8360A6F00D89B1F14F9AFCF496E141EE8D62E4A23747804BC9F7F9DBB7DDD6B7CCCB77D440D3C1F0E74B0E56A39F85FA2E45D35503CDD4A6E3C11B77882F2A3B26E77A3781D450FAA3E36B62A674991BAF62AEEEB683C2B05BFCBFE659699B55EB795970F0C2121A7C996AE29A66D6BA16CCE6C4DBFF4775FBA5861CD4BDDE1880F1FC2DB9F05BAB24070CFB2D2D043B7E0D01C52F3F8ECB2C789C1F3576BB3EF7486A8E760639CD8FD054D6DF41DAE17BD94914FCF2438801BDC86CA06EB334BA70FAB7B2BD84D66F4A0AE028F0AD3365F8EC24081AB598454FE95BD60D7D2818A3E4D3D272024358266FD04E2FF96E79E89F52C06C7FC387D4B6CDCE9D47FFBC7E701FB92959DD6CA7132925A09FA39ECA0A5792B068013A1AED77B933435BA0EE7054E9A5D2F166494C15A84F10419D3CD3D46ABA8A5772A9824AC2AF8BA8FE1E38FC4B3FAA94F7BFF8E84987B4BC29C575585B1D9A72104566B2DF00C83A5021211103987754951646C49B787140AE837945B97EE5A5BA61A9B7C7674EDA09BE3D5F4ED6F46CAD3D685834C2423AB22D07D669E8744C6990EF9423644454A98635200506E19871C8B7591E6EAA7AE35BBB94A20FBB236E84568AF7D502DB69D57453BAF80184553F424458D30763D90CC9340085BD61D2EF0927DD30732D9B3978D144BA8AA90C4F9A5B8D8E3942233D576F4BBE696F947CD736F214AA0CDEC481B065F8B98BC922E1F04ECA2140A8D8A723A01BEF15769EC719656B6A55E1112B90B3B15DC72B4F5439FCBF7E9ABFE234759C8CEAB0E875B0BB9B4D60924F24E151F9F4159085252B4BE8D760B0CB681E8DE2DE3150332AC1CD9FBD3E870F666214C1483C021625ABBE38D3708790B25EC835A87A45582D3909F3C5C67D34E242000F3A7CAF4DFF0FC664992ADCF675FAE861CDBEB5B1E427524DA9D5D2F84166BEC40E101FADA562AD57D920701467631FC768655C3E1A48E7BB5F539B91CCCDC7082ADBCF4E6AFF9C5E66779F9C679D2ACB1E0563AE12D96E251C8A2BE12608FDE2BB22A2F6FF270D68718AA915DEBDBEF4062D21F960D14692502ABA48D6832B453FADCCD3B52ABC467ABBDBA402D01E9CD424B0F9EB930B3CC48A503AB9287C273B7B92FBE748FDB3ED401954D9152F255398C1490E4A5CEF789E8EA8C20EBFF665404F85BB758C5F9F423B768BA22E040885F522F16BFFFF27426046A7715A7A6518B063BC307DD67D1C57727BE23953EB10AF7E89FA64F5B6FA78CA54DA2538A2C1C14474011CD9869D3A07C0917B2FDFF5886A63975460FB27A35B35577CD01E84FFD2B50B1CA96A85780644CE921A189A051E2AEA2574A6C54C1033B05B0A640F187EB25808754BAB5A50A0AF79268E6D954712375C15512EF4BFEF8A6CF2EA91B7B6A0392EF1185B01851DADC160C8ADD7954543C6F093329F4E8AA78757FF2AF981A23C95993EAE0092158B56E675CCDFFD630A1DB4D77A391B8E6558493D1FC87EE07E2291F2CA3319B7E5B1C8184FB4A860356623188F5B0B500F4EBAB9FF5EE7A1D12FD632AD4D0D1AEEBBB3CED119B0D0ED89AD2A2D11CBDC9FD78FF903D9DA73577C9B4965F6AB4CD47B9A6C70614345E7ED9815F3647D78BF2A51979D235AEC5A157FFE5A5AAB38071FE961683E77993B41E0415FC8E86B3D93A790F467CDBD63489817A9761504248BBD7BD9A0BE452D1B753D0FAE9640304E6ED22CFB00D73E4987217F44F572E95937EBB84D708EF78C74F505C04548E68286E698F0DC44B93089881F602FA00AD83BE73DCBEC0D81B143D43E19AABEE95DE0C5D968284CC1A62C2A0E6A27632F332D4904340CD0CABD58249AAEB2A96460529EB987EF46FBC0A675DEDE1AD8A4E09890E321720106E01EA383AC4E7EDC7257B5CFD4D1A0D3C99D80FDE1A9E0BDBE53B2B5BA69301B080A37754632A694B2A609A502947E0B537D268927F09B3EB90AF279EC61A06B581F943CADA9635AEFF278C7BAF16CBE4721AC3FA7BA78222A0085E0403B320EA93500F667A63205410BF70A821B7686B55DE895A0AE2F0234ED5020FD500EF51624596B4911957D7FDEDA3DBA4D8B0A8069B6026227ECE331EA97462C9F4074B4D434836541BE46B0B8E3BA8BF3B137A01A5B7C418411B288CE725B7475CEDA1B363B5F728E045AFD1722C14ECC174BFFB33E0164BEF496875A85EE7E979ACFAA382BD0C3513F635D3EB8AD1A87FB5D1584FC3F3755AA726584A8FE0B736D665F3660BAC42EFA6DC2D9880AEAF7E6F9BF2AE6269AA3132154771EC96B33FD13E16183AF35041C2BCB3F691C00EE3333A7BC30DC84E42CB5BBD7A3A6593C668A27E6E6845E96846992FF97F4317E52069D58F3E1D7D500776802879CC738349AEC92BCE22FA57BE43C1D063A97642A3C308A90031B3CACFB50A49E61A4091072C94C432DDDD8C9869BBB79F3919B410C6C6763EC615947BF5D4C7F9A88961482B5B7B65965824C24DD0090F5938603A34DF2936804D3C355A60C32E8698ACE7083D17D714DCE0E836C80F18B7ED5C221B18F5CCB4CA0B4E7CFB3140406BF929E2003F6CB826D8AFBC4C9D3A63AFAB625F0CFF96410FA6791707F79D90E95436B5F01809421DB0A3828D42E4260310A02B05BB6BA82A19EC1B14925E725A49A5D74B527ACFF271DFD1FB9CDF5087038EA5F06028EE77DBFB8CDF4737C9F005DA987D36007C310CE580332D860E9167588BF1D9EE53DF3426B94F39AB1ACEE86C455A1440EAF905020637EBE7B3C8E9485F7132359E930AD2F4298F87BBE2D97465506772565F055638D6619A9FEF455A66F2D6EF5211DAD4386CCCF55544937475D6D851F6806B192EAE04C837B03EC7416627C77B39928EA4DB7CA14CDFB3B5DECD2C7D7E9A1BCDBDB6AE2F851360174BC0F4D93C0037EB73C3D0A83BD5314806A7971F7D9703B0D2F13C9D8C7639F2B08D3793EA50951E720499936AA0DB0ADF2953AC9A6B122F4F75333DA727842DAB2FDA46177496F5F0233C88D165BF6F04D146F06E379B0CA0309AD5CE54ABF88A2256F3936DF38A09A11945F53668CDE632BC94E5BD0202CCB56D9930DC32A292064938A221D43C761DD48BDCD21AE8B650121F664CFB8C323DA68AD2391976D23AA13577FA36E2C96D287AD0935860010D8D19CD83838B967960FE4A861372FA3DE38F09F5ACCC55125154B80562419ECD482F83D08AD4260BC5CA488687F951520CFAC0F2D0B429F53EA6D840F789C695620110D61D9CE6909007A36C5512D3E0E95A4A151E7C554D99BE6E112C54736835D1A7E6E49BDB581773B365EC39B56DC3A960563200362C07C3F5CCAF97BCC3CC1C92526854EC3F7B33746C609F16C68E34110281B08A9684B9DD3B441E7C6817C69DD4083EA624C39EF49F9ED65094E85A1B893ED8B899669BA80EB964ACA6922E15E91E72200675F66CF7F323BD1F1EB16AE1A4F544B00D90DD0883FB4C031E7FEC2CF72E7C8DAAFE50291163DC6C79C3914EC18D034253B7DBC589C4C7931561C57ED046B1AFF328363F561528C7FA1CA55F4CDE0821AD2A324564E3F81086BA1633E46D897FB2CF5AE3E65A27821CE8B193B9BFFB79F48C9E114985EC9EB90C956C959AF969D5B1289AF0E16654EE953BD9DB0CAC78797395CEE910A94C47A6BFA6BC9281C24D13EBF171516AE2B5EDE5431245AB8898079F86B23624307E6D8942CBC0DECDE88FE6866103CCB7495DA0F221D7BC319F4D7AF57F1D53C8401B33AF87A78321E586246A3C8D606D14C988A752B527857D0FE2CF1F09934E1033319BD1630D66FF0217BEA8DFDDE5A6A42C5CA866FF33EBA86EED499FEDBCACD6DB5A7BF24CA7CDDDF198DEFA44A3497D667E4C16E7AF19060A619950ABA59BA83D49BA5F5DC3F7F61B8E5858C6C5CC31908C930C35DEFB29AB2839F3F957710B62DF90A2464B77FA5320450E533056D58E07DDB34F5759398AC9ED55B73749D49000DD586AFEDECBA6EFD127FF0753D1BA429BA0AD64023AEC13E9515E2BEB75F6091A5E7ADDB912D1C8714F4D3E1D903E5A04D453C4CAC69CC4927CF22A4225C7A95D0DBB1E734583EC8D343B7003F4E37B6DEB64DC921A46A74615C98A84C57E8F5867A61A19A7AA598103FE5CB74610FDFB3645D345F17BF3174609DC6FD3062B7F2F7CF37EA0A9D70FFF42FE7AB5C33BDD76898931240FA3536536995D42ACCBA7148F630E76E581DD6A43B06D94BEE3FFC3056013FA30CE62AA4001F401F8D7239D78ABBCDD52E53C730BC1BD47D97743EF7D1619575E31019EA769D6973893EF5F86E70C934F8864113CD885045FA53620141C33CCC363594FF51735AC6610F2E70E0032160DFE617CBAE3B82ACAC082263CEDBDB08056F480704370DE76FD41C48FE823376103A0EA7081B60ABA01C6F90B1306ABB71320EF29D4E70F1AB696D2D5EE1E35A1AD8019E9402634F2EFD047641B796FA0B736FCBADD2482F5EA6F089A4098595879C569E017194E4BF722FB7BA2B82EA9B283AC858A8C947C846D477C6695BBB41D8A78BBE44F5C849948DAA5F08D7E77A648C6BADE646DCB3262C3AE4AC4F94D0CAA04F955F89BDEDA06123C91A3E4D0A45F1B5381A657FB17C8B3423FF74369A8B7D7C99B75817AE9477675CC64983B3BED6228952564DCD2417BE451FA8D603745CC894CF71CB6D64BA44FD423ECDBECD617478937"))
